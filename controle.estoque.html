<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Estoque - Logística OZT</title>
<style>
body { margin:0; font-family: Arial, sans-serif; background-color:#f0f4f8; }
h2 { text-align:center; margin:15px 0 5px; color:#064e3b; }

/* Centraliza pesquisa + painel juntos */
.search-panel {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin: 10px auto;
  flex-wrap: wrap;
}
.search-bar label {
  font-weight: bold;
  margin-right: 6px;
}
.search-bar select {
  padding:8px;
  border:1px solid #ccc;
  border-radius:6px;
  min-width:220px;
  font-size:14px;
  cursor: pointer;
}

/* Painel Estoque Mínimo */
.min-stock-panel {
  background: #fff;
  border: 2px solid #199E80;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: bold;
  color: #064e3b;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.min-stock-panel span {
  color: #ef4444;
  font-weight: bold;
}

/* Legenda horizontal sob a pesquisa */
.legend {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  padding: 8px 10px;
  flex-wrap: wrap;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: bold;
  user-select: none;
}
.legend-color {
  width:18px;
  height:18px;
  border-radius:4px;
  border:1px solid rgba(0,0,0,0.08);
  box-shadow: 0 1px 1px rgba(0,0,0,0.04) inset;
}
.legend-color.critico { background-color:#fde68a; }
.legend-color.baixo   { background-color:#bfdbfe; }
.legend-color.adequado{ background-color:#bbf7d0; }
.legend-color.negativo{ background-color:#fecaca; }

.container { padding:10px; }
table { width:100%; border-collapse: collapse; margin-top:15px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background-color:#059669; color:white; cursor: default; }

tr.negativo { background-color: #fecaca; }
tr.critico  { background-color: #fde68a; }
tr.baixo    { background-color: #bfdbfe; }
tr.adequado { background-color: #bbf7d0; }

tr:hover { filter: brightness(0.95); cursor: pointer; }

.top-bar {
  display: flex;
  justify-content: flex-end;
  background: #059669;
  padding: 8px;
}
.btn-relatorios {
  background-color: #f97316; /* laranja */
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: 0.2s;
  margin-right: 8px;
}
.btn-relatorios:hover {
  opacity: 0.9;
  transform: scale(1.05);
}
.btn-sair {
  background-color: #ef4444;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: 0.2s;
}
.btn-sair:hover { opacity: 0.9; transform: scale(1.05); }

@media (max-width:600px){
  .legend { gap:12px; }
  .legend-item { font-size:14px; }
  .search-panel { flex-direction: column; gap: 10px; align-items: center; }
}
</style>
</head>
<body>

<div class="top-bar">
  <button class="btn-relatorios" onclick="window.location.href='relatório.html'">RELATÓRIOS</button>
  <button class="btn-sair" onclick="window.location.href='index.html'">Sair</button>
</div>

<h2>Controle de Estoque</h2>

<!-- Barra de pesquisa + painel -->
<div class="search-panel">
  <div class="search-bar">
    <label for="produtoSelect">Pesquisar produto: </label>
    <select id="produtoSelect" onchange="filtrarPorProduto()">
      <option value="">-- Todos --</option>
    </select>
  </div>
  <div class="min-stock-panel" id="painelEstoqueMinimo">
    Estoque Mínimo: <span>--</span>
  </div>
</div>

<!-- Legenda com checkboxes para filtro -->
<div class="legend">
  <label class="legend-item">
    <input type="checkbox" id="chkCritico" checked onchange="filtrarTabela()"/>
    <span class="legend-color critico"></span>
    CRÍTICO
  </label>
  <label class="legend-item">
    <input type="checkbox" id="chkBaixo" checked onchange="filtrarTabela()"/>
    <span class="legend-color baixo"></span>
    BAIXO
  </label>
  <label class="legend-item">
    <input type="checkbox" id="chkAdequado" checked onchange="filtrarTabela()"/>
    <span class="legend-color adequado"></span>
    ADEQUADO
  </label>
  <label class="legend-item">
    <input type="checkbox" id="chkNegativo" checked onchange="filtrarTabela()"/>
    <span class="legend-color negativo"></span>
    NEGATIVO
  </label>
</div>

<div class="container">
  <table>
    <thead>
      <tr>
        <th>Código</th>
        <th>Descrição</th>
        <th>Quantidade Entrada</th>
        <th>Quantidade Saída</th>
        <th>Unidade</th>
        <th>Categoria</th>
        <th>Saldo Estoque</th>
      </tr>
    </thead>
    <tbody id="estoqueTabela"></tbody>
  </table>
</div>

<script>
// Função de formatação numérica
function formatarNumero(valor){
  if (isNaN(valor) || valor === null) return "0";
  let num = Number(valor);

  if (Number.isInteger(num)) {
    return num.toLocaleString("pt-BR");
  }

  return num.toLocaleString("pt-BR", {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2
  });
}

// Dados da aplicação provenientes do localStorage
let entradas = JSON.parse(localStorage.getItem("entradas")) || [];
let saidas = JSON.parse(localStorage.getItem("saidas")) || [];
let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
let estoqueGlobal = {}; 

function atualizarEstoque(){
    estoqueGlobal = {};

    entradas.forEach(e=>{
        if(!estoqueGlobal[e.codigo]){
            estoqueGlobal[e.codigo] = { descricao:e.descricao, categoria:e.categoria, unidade:e.unidade, entrada:0, saida:0 };
        }
        estoqueGlobal[e.codigo].entrada += parseFloat(e.quantidade) || 0;
    });

    saidas.forEach(s=>{
        if(!estoqueGlobal[s.codigo]){
            estoqueGlobal[s.codigo] = { descricao:s.descricao, categoria:s.categoria, unidade:s.unidade, entrada:0, saida:0 };
        }
        estoqueGlobal[s.codigo].saida += parseFloat(s.quantidade) || 0;
    });

    popularSelectProdutos();
    montarTabela();
}

function popularSelectProdutos(){
    const select = document.getElementById("produtoSelect");
    select.innerHTML = '<option value="">-- Todos --</option>';
    for(let cod in estoqueGlobal){
        let opt = document.createElement("option");
        opt.value = cod;
        opt.textContent = estoqueGlobal[cod].descricao + " ("+cod+")";
        select.appendChild(opt);
    }
}

function classificarNivel(saldo, estoqueMinimo){
  const min = isNaN(parseFloat(estoqueMinimo)) ? 0 : parseFloat(estoqueMinimo);
  if (saldo < 0) return "negativo";
  if (min <= 0) return "adequado";
  if (saldo === 0) return "critico";
  if (saldo > 0 && saldo < min) return "critico";
  if (saldo >= min && saldo < (min * 1.2)) return "baixo";
  return "adequado";
}

function montarTabela(){
    const produtoFiltro = document.getElementById("produtoSelect").value;
    let tbody = document.getElementById("estoqueTabela");
    tbody.innerHTML = "";

    for(let cod in estoqueGlobal){
        if(produtoFiltro && produtoFiltro !== cod) continue;

        let item = estoqueGlobal[cod];
        let saldo = (item.entrada || 0) - (item.saida || 0);

        let produto = produtos.find(p => String(p.codigo) === String(cod));
        let estoqueMinimo = produto ? parseFloat(produto.estoqueMinimo) : 0;

        let nivelClass = classificarNivel(saldo, estoqueMinimo);

        let tr = document.createElement("tr");
        tr.className = nivelClass;
        tr.dataset.codigo = cod;
        tr.innerHTML = `<td>${cod}</td>
                        <td>${item.descricao || ''}</td>
                        <td>${formatarNumero(item.entrada)}</td>
                        <td>${formatarNumero(item.saida)}</td>
                        <td>${item.unidade || ''}</td>
                        <td>${item.categoria || ''}</td>
                        <td>${formatarNumero(saldo)}</td>`;

        tr.addEventListener("click", ()=> {
            document.getElementById("produtoSelect").value = cod;
            atualizarPainelEstoqueMinimo(cod);
            filtrarPorProduto();
        });

        tbody.appendChild(tr);
    }

    atualizarPainelEstoqueMinimo(produtoFiltro);
    filtrarTabela();
}

function filtrarTabela(){
    const mostrarCritico = document.getElementById("chkCritico").checked;
    const mostrarBaixo   = document.getElementById("chkBaixo").checked;
    const mostrarAdeq    = document.getElementById("chkAdequado").checked;
    const mostrarNeg     = document.getElementById("chkNegativo").checked;

    document.querySelectorAll("#estoqueTabela tr").forEach(row=>{
        if (row.classList.contains("critico") && !mostrarCritico) row.style.display = "none";
        else if (row.classList.contains("baixo") && !mostrarBaixo) row.style.display = "none";
        else if (row.classList.contains("adequado") && !mostrarAdeq) row.style.display = "none";
        else if (row.classList.contains("negativo") && !mostrarNeg) row.style.display = "none";
        else row.style.display = "";
    });
}

function filtrarPorProduto(){
  montarTabela();
}

function atualizarPainelEstoqueMinimo(codigo){
  const painel = document.getElementById("painelEstoqueMinimo").querySelector("span");
  if(!codigo){
    painel.textContent = "--";
    return;
  }
  let produto = produtos.find(p=> String(p.codigo) === String(codigo));
  painel.textContent = (produto && produto.estoqueMinimo)
    ? formatarNumero(produto.estoqueMinimo)
    : "Não cadastrado";
}

try {
  atualizarEstoque();
} catch (err){
  console.error("Erro ao inicializar:", err);
}
</script>

</body>
</html>
