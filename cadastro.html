<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro de Produtos - Logística OZT</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- CSS com cache-busting -->
  <link id="main-style" rel="stylesheet" href="style.css">

  <style>
    html, body {
      margin:0; padding:0; height:100%;
      font-family: Arial, sans-serif;
      font-size: 15px;
    }
    body { background-color:#f0f4f8; display:flex; flex-direction:column; }

    .header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      background-color:#199E80;
      padding:10px 15px;
    }
    .header h2 { margin:0; color:white; }

    button {
      margin:4px;
      padding:5px 10px;
      border:none;
      border-radius:5px;
      color:white;
      cursor:pointer;
      font-weight:bold;
      font-size:13px;
    }
    .btn-add { background-color:#16a34a; }
    .btn-edit { background-color:#0ea5e9; }
    .btn-delete { background-color:#b91c1c; }
    .btn-clear { background-color:#2563eb; }
    .btn-sair { background-color:#dc2626; }
    .btn-export { background-color:#059669; }
    .btn-showall { background-color:#f97316; }
    .btn-showall:hover { background-color:#ea580c; }

    .container { padding:10px; flex:1; overflow:auto; }

    .form-inline {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:15px;
    }
    .form-group { display:flex; flex-direction:column; }
    .form-group label { font-weight:bold; margin-bottom:3px; font-size:14px; }
    .form-group input,
    .form-group select { font-size:14px; padding:6px; }
    .descricao { flex:2; min-width:250px; }
    .codigo, .estoque, .unidade, .categoria, .data { flex:1; min-width:120px; }

    #searchGroup {
      background-color:#bbf7d0;
      padding:10px;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    #searchGroup label { font-weight:bold; }
    #searchGroup select { flex:1; padding:6px; font-size:14px; }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:15px;
      font-size:15px;
    }
    th, td { border:1px solid #ccc; padding:10px; text-align:center; }
    th { background-color:#059669; color:white; }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <h2>Cadastro de Produtos</h2>
    <div class="btn-group">
      <button class="btn-add" id="btnProdutoAdd">Adicionar Produto</button>
      <button class="btn-edit" id="btnProdutoEdit">Editar Produto</button>
      <button class="btn-delete" id="btnProdutoDelete">Excluir Produto</button>
      <button class="btn-clear" id="btnProdutoClear">Limpar Campos</button>
      <button class="btn-export" onclick="exportarExcel()">Exportar para Excel</button>
      <button class="btn-sair" onclick="sairParaIndex()">Sair</button>
    </div>
  </div>

  <div class="container">

    <!-- Formulário -->
    <div class="form-inline">
      <div class="form-group codigo">
        <label>Código:</label>
        <input type="text" id="produtoCodigo" placeholder="Digite manualmente">
      </div>
      <div class="form-group descricao">
        <label>Descrição:</label>
        <input type="text" id="produtoDescricao">
      </div>
      <div class="form-group estoque">
        <label>Estoque Mínimo:</label>
        <input type="number" id="produtoEstoqueMinimo">
      </div>
      <div class="form-group unidade">
        <label>Unidade:</label>
        <select id="produtoUnidade">
          <option value="">Selecione</option>
          <option>UN</option>
          <option>KG</option>
          <option>L</option>
          <option>CX</option>
          <option>PÇ</option>
        </select>
      </div>
      <div class="form-group categoria">
        <label>Categoria:</label>
        <input type="text" id="produtoCategoria">
      </div>
      <div class="form-group data">
        <label>Data Cadastro:</label>
        <input type="date" id="produtoData">
      </div>
    </div>

    <!-- Pesquisa -->
    <div id="searchGroup">
      <label>Pesquisar Produto:</label>
      <select id="produtoSearchSelect" onchange="pesquisarProduto()">
        <option value="">-- Selecione --</option>
      </select>
      <button class="btn-showall" onclick="mostrarTodosProdutos()">Mostrar Todos</button>
    </div>

    <!-- Tabela -->
    <table>
      <thead>
        <tr>
          <th>Código</th>
          <th>Descrição</th>
          <th>Estoque Mínimo</th>
          <th>Unidade</th>
          <th>Categoria</th>
          <th>Data Cadastro</th>
        </tr>
      </thead>
      <tbody id="produtoTabelaCorpo"></tbody>
    </table>
  </div>

<script>
let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
let modoEdicao = false;
let editIndex = null;

document.getElementById("produtoData").valueAsDate = new Date();

function atualizarTabela(lista = null){
  let tbody = document.getElementById("produtoTabelaCorpo");
  tbody.innerHTML = "";
  let dados = lista || produtos;
  dados.forEach((p, i) => {
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.codigo}</td>
      <td>${p.descricao}</td>
      <td>${Number(p.estoqueMinimo).toLocaleString("pt-BR")}</td>
      <td>${p.unidade}</td>
      <td>${p.categoria}</td>
      <td>${p.data}</td>`;
    tr.onclick = () => preencherCampos(i);
    tbody.appendChild(tr);
  });
}

function atualizarComboPesquisa() {
  let select = document.getElementById("produtoSearchSelect");
  select.innerHTML = "<option value=''>-- Selecione --</option>";
  produtos.forEach((p, i) => {
    let opt = document.createElement("option");
    opt.value = i;
    opt.textContent = p.descricao;
    select.appendChild(opt);
  });
}

function salvarLocalStorage(){
  localStorage.setItem("produtos", JSON.stringify(produtos));
}

function limparCampos(){
  document.getElementById("produtoCodigo").value = "";
  document.getElementById("produtoDescricao").value = "";
  document.getElementById("produtoEstoqueMinimo").value = "";
  document.getElementById("produtoUnidade").value = "";
  document.getElementById("produtoCategoria").value = "";
  document.getElementById("produtoData").valueAsDate = new Date();
  modoEdicao = false;
  editIndex = null;
  document.getElementById("btnProdutoAdd").innerText = "Adicionar Produto";
}

function adicionarProduto(){
  let codigo = document.getElementById("produtoCodigo").value.trim();
  let descricao = document.getElementById("produtoDescricao").value.trim();
  let estoqueMinimo = parseFloat(document.getElementById("produtoEstoqueMinimo").value.trim()) || 0;
  let unidade = document.getElementById("produtoUnidade").value;
  let categoria = document.getElementById("produtoCategoria").value.trim();
  let data = document.getElementById("produtoData").value;

  if(!codigo || !descricao || !unidade || !categoria){
    alert("Preencha todos os campos obrigatórios!");
    return;
  }

  if(modoEdicao){
    produtos[editIndex] = {codigo, descricao, estoqueMinimo, unidade, categoria, data};
    alert("Produto atualizado com sucesso!");
  } else {
    if(produtos.some(p => p.codigo === codigo)){
      alert("Código já cadastrado!");
      return;
    }
    produtos.push({codigo, descricao, estoqueMinimo, unidade, categoria, data});
    alert("Produto adicionado com sucesso!");
  }

  salvarLocalStorage();
  atualizarTabela();
  atualizarComboPesquisa();
  limparCampos();
}

function preencherCampos(index){
  let p = produtos[index];
  document.getElementById("produtoCodigo").value = p.codigo;
  document.getElementById("produtoDescricao").value = p.descricao;
  document.getElementById("produtoEstoqueMinimo").value = p.estoqueMinimo;
  document.getElementById("produtoUnidade").value = p.unidade;
  document.getElementById("produtoCategoria").value = p.categoria;
  document.getElementById("produtoData").value = p.data;
  modoEdicao = true;
  editIndex = index;
  document.getElementById("btnProdutoAdd").innerText = "Salvar Alterações";
}

function excluirProduto(){
  if(editIndex === null){ alert("Selecione um produto clicando na tabela!"); return; }
  if(confirm("Deseja realmente excluir este produto?")){
    produtos.splice(editIndex,1);
    salvarLocalStorage();
    atualizarTabela();
    atualizarComboPesquisa();
    limparCampos();
    alert("Produto excluído!");
  }
}

function pesquisarProduto(){
  let select = document.getElementById("produtoSearchSelect");
  let index = select.value;
  if(index === "") {
    atualizarTabela();
  } else {
    atualizarTabela([produtos[index]]);
  }
}

function mostrarTodosProdutos(){
  atualizarTabela();
  document.getElementById("produtoSearchSelect").value = "";
}

function exportarExcel(){
  if(produtos.length === 0){
    alert("Nenhum produto cadastrado!");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(produtos);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Produtos");
  XLSX.writeFile(wb, "entrada_produtos.xlsx");
}

function sairParaIndex(){
  window.location.href = "index.html";
}

document.getElementById("btnProdutoAdd").onclick = adicionarProduto;
document.getElementById("btnProdutoEdit").onclick = () => { if(editIndex!==null) preencherCampos(editIndex); else alert("Clique em um produto na tabela!"); };
document.getElementById("btnProdutoDelete").onclick = excluirProduto;
document.getElementById("btnProdutoClear").onclick = limparCampos;

atualizarTabela();
atualizarComboPesquisa();

// Cache-busting automático para JS externo
const timestamp = new Date().getTime();
const script = document.createElement('script');
script.src = 'script.js?v=' + timestamp;
document.body.appendChild(script);

</script>
</body>
</html>
